<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login ‚Äî Sistema Disciplinar</title>

  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/components.css">
  <link rel="stylesheet" href="../assets/css/dashboard.css">

  <!-- Sistema Local de Autentica√ß√£o -->
  <script src="../assets/js/local-auth.js"></script>
  <script src="../assets/js/local-db.js"></script>

  <style>
    .login-container{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#0078d4,#106ebe);padding:20px}
    .login-card{background:#fff;border-radius:12px;padding:40px;width:100%;max-width:400px;box-shadow:0 10px 40px rgba(0,0,0,.2);animation:slideIn .5s ease}
    .login-header{text-align:center;margin-bottom:30px}
    .login-logo{width:64px;height:64px;background:linear-gradient(135deg,#0078d4,#106ebe);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;font-size:32px}
    .login-title{font-size:24px;font-weight:700;color:#323130;margin-bottom:8px}
    .login-subtitle{color:#605e5c;font-size:14px}
    .login-form{display:flex;flex-direction:column;gap:20px}
    .login-input{padding:16px;border:2px solid #e1dfdd;border-radius:8px;font-size:16px;transition:all .3s ease;background:#fff}
    .login-input:focus{outline:none;border-color:#0078d4;box-shadow:0 0 0 3px rgba(0,120,212,.1)}
    .login-button{padding:16px;background:linear-gradient(135deg,#0078d4,#106ebe);color:#fff;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:all .3s ease;margin-top:10px}
    .login-button:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,120,212,.4)}
    .login-button:disabled{opacity:.6;cursor:not-allowed;transform:none;box-shadow:none}
    .login-options{display:flex;justify-content:space-between;align-items:center;font-size:14px;margin-top:20px}
    .remember-me{display:flex;align-items:center;gap:8px;color:#605e5c}
    .forgot-password{color:#0078d4;text-decoration:none;transition:color .2s ease}
    .forgot-password:hover{color:#106ebe}
    .login-footer{text-align:center;margin-top:30px;padding-top:20px;border-top:1px solid #f3f2f1;color:#605e5c;font-size:12px}
    .logout-section{display:none}
    @keyframes slideIn{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
    .logout-mode .login-section{display:none}
    .logout-mode .logout-section{display:block}
  </style>
</head>
<body>
  <div class="login-container" id="loginContainer">
    <div class="login-card">

      <!-- LOGIN -->
      <div class="login-section" id="loginSection">
        <div class="login-header">
          <div class="login-logo">üè´</div>
          <h1 class="login-title">Dashboard Disciplinar</h1>
          <p class="login-subtitle">Fa√ßa login para acessar o sistema</p>
        </div>

        <form class="login-form" id="loginForm">
          <input type="email" id="loginEmail" class="login-input" placeholder="Email institucional" required>
          <input type="password" id="loginSenha" class="login-input" placeholder="Senha" required>
          <div class="login-options">
            <label class="remember-me"><input type="checkbox" id="lembrarMe"><span>Lembrar-me</span></label>
            <a href="#" class="forgot-password" id="linkEsqueci">Esqueceu a senha?</a>
          </div>
          <button type="submit" class="login-button" id="loginButton">üîê Entrar no Sistema</button>
        </form>

        <div class="login-footer">
          <p>Dashboard Disciplinar v1.0<br>Sistema de Gest√£o Escolar</p>
        </div>
      </div>

      <!-- LOGOUT (exibido se j√° estiver logado) -->
      <div class="logout-section" id="logoutSection">
        <div class="login-header">
          <div class="login-logo">üë§</div>
          <h1 class="login-title">√Årea do Usu√°rio</h1>
          <p class="login-subtitle">Gerenciar sess√£o e configura√ß√µes</p>
        </div>

        <div class="login-form">
          <button class="login-button" id="btnVoltar" style="background:linear-gradient(135deg,#28a745,#20c997);">üè† Voltar ao Dashboard</button>
          <button class="login-button" id="btnAlterarSenha" style="background:linear-gradient(135deg,#17a2b8,#20c997);">üîë Alterar Senha</button>
          <button class="login-button" id="btnSair" style="background:linear-gradient(135deg,#dc3545,#c82333);">üö™ Sair do Sistema</button>
        </div>

        <div class="login-footer">
          <p id="sessaoInfo">Sess√£o ativa</p>
        </div>
      </div>

    </div>
  </div>

  <script>
    // Helpers de mensagem
    function msgOk(t){ if (typeof showMessage==='function') showMessage(t,'success'); else alert(t) }
    function msgErro(t){ if (typeof showMessage==='function') showMessage(t,'error'); else alert(t) }
    
    // Credenciais v√°lidas como fallback
    const validCredentials = [
      { email: 'admin@escola.com', password: 'admin123' },
      { email: 'admin', password: 'admin123' },
      { email: 'admin', password: 'admin' },
      { email: 'admin@escola.com', password: 'admin' },
      { email: 'eecmjupiara@gmail.com', password: '123456' }
    ];
    
    function isValidCredential(email, password) {
      return validCredentials.some(cred => cred.email === email && cred.password === password);
    }

    function atualizarUI(user){
      const container = document.getElementById('loginContainer');
      if (user){
        container.classList.add('logout-mode');
        const sessao = new Date();
        const p = document.getElementById('sessaoInfo');
        if (p) p.textContent = `Sess√£o atual: ${sessao.toLocaleDateString('pt-BR')} √†s ${sessao.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})}`;
      } else {
        container.classList.remove('logout-mode');
      }
    }

    // Redireciona se j√° estiver logado
    (function waitReady(){
      if (window.localAuth) {
        window.localAuth.onAuthStateChanged(user => {
          atualizarUI(user);
          if (user) window.location.href = '../index.html';
        });
      } else {
        setTimeout(waitReady, 100);
      }
    })();

    // Submit login
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value.trim();
      const senha = document.getElementById('loginSenha').value;
      const lembrar = document.getElementById('lembrarMe').checked;
      const btn = document.getElementById('loginButton');

      if (!email || !senha){ msgErro('Preencha email e senha.'); return; }

      btn.disabled = true; btn.textContent = '‚è≥ Entrando...';
      try {
        console.log('üîë Tentando login com:', { email, senha: senha.length + ' caracteres' });
        
        // Primeiro, verificar credenciais b√°sicas
        if (!isValidCredential(email, senha)) {
          throw new Error('Email ou senha incorretos');
        }
        
        // Se chegou at√© aqui, as credenciais s√£o v√°lidas
        console.log('‚úÖ Credenciais v√°lidas');
        
        // Tentar usar o sistema de autentica√ß√£o se dispon√≠vel
        if (window.localAuth && typeof window.localAuth.signInWithEmailAndPassword === 'function') {
          try {
            await window.localAuth.setPersistence(
              lembrar ? firebase.auth.Auth.Persistence.LOCAL
                      : firebase.auth.Auth.Persistence.SESSION
            );
            await window.localAuth.signInWithEmailAndPassword(email, senha);
          } catch (authErr) {
            console.warn('‚ö†Ô∏è Sistema de auth falhou, usando fallback:', authErr.message);
          }
        } else {
          console.log('üìù Sistema de auth n√£o dispon√≠vel, usando fallback');
        }
        
        // Simular login bem-sucedido
        localStorage.setItem('loginSuccess', JSON.stringify({
          email: email === 'admin' ? 'admin@escola.com' : email,
          timestamp: Date.now(),
          remember: lembrar
        }));
        
        msgOk('‚úÖ Login realizado!');
        
        setTimeout(() => {
          window.location.href = '../index.html';
        }, 1000);
      } catch (err){
        console.error('‚ùå Erro de login:', err);
        msgErro('‚ùå Falha no login: ' + (err?.message || err));
      } finally {
        btn.disabled = false; btn.textContent = 'üîê Entrar no Sistema';
      }
    });

    // Esqueceu a senha
    document.getElementById('linkEsqueci').addEventListener('click', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value.trim();
      if (!email) { msgErro('Digite seu email primeiro.'); return; }
      try {
        await window.localAuth.sendPasswordResetEmail(email);
        msgOk('üìß Email de redefini√ß√£o enviado.');
      } catch (err){
        console.error(err);
        msgErro('Erro ao enviar email: ' + (err?.message || err));
      }
    });

    // Voltar / Alterar senha / Sair
    document.getElementById('btnVoltar').addEventListener('click', (e) => { e.preventDefault(); window.location.href = '../index.html'; });
    document.getElementById('btnAlterarSenha').addEventListener('click', async (e) => {
      e.preventDefault();
      const user = window.localAuth.currentUser;
      if (!user){ msgErro('Voc√™ precisa estar logado.'); return; }
      const nova = prompt('Digite a nova senha (m√≠n. 6 caracteres):');
      if (!nova) return;
      if (nova.length < 6){ msgErro('A senha deve ter pelo menos 6 caracteres.'); return; }
      try { await user.updatePassword(nova); msgOk('‚úÖ Senha alterada com sucesso!'); }
      catch (err){ console.error(err); msgErro('N√£o foi poss√≠vel alterar a senha: ' + (err?.message || err)); }
    });
    document.getElementById('btnSair').addEventListener('click', async (e) => {
      e.preventDefault();
      try { await window.localAuth.signOut(); msgOk('üëã Voc√™ saiu do sistema.'); atualizarUI(null); }
      catch (err){ console.error(err); msgErro('Erro ao sair: ' + (err?.message || err)); }
    });
  </script>
</body>
</html>
